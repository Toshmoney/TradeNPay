<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaBills | Buy Airtime </title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/aside.css">
    <link rel="stylesheet" href="css/DataPlans.css">
</head>
<body>
    <section class="dashboard-container">
        <%- include('../partials/aside') %>
       <main>
        <%- include('../partials/mobileHeader') %>
        <div class="dashboard-main-top">
            <h1>BUY Airtime</h1>
            <div class="input-bar">
                <div>
                    <img src="images/tabler-icon-bell.png" alt="">
                </div>
                <div class="profile-picture">
                    <img src="images/Frame 12.png" alt="profile-picture">
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="choose form-field">
                <label class="bold" for="network">SELECT NETWORK PROVIDER</label>
                <select class="network" name="network" id="network" value="Select Option">
                    <option value="">Select Option</option>
                    <option value="BAD STANDARD">MTN NG</option>
                    <option value="BAB STANDARD">GLO</option>
                    <option value="BAC STANDARD">9MOBILE</option>
                    <option value="BAA STANDARD">AIRTEL NG</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <div class="form-field">
                <label class="bold" for="phoneNumber">PHONE NO.</label>
                <input type="tel" name="phoneNumber" id="phoneNumber" placeholder="0901 2345 678">
            </div>
            <div class="form-field">
                <label class="bold" for="amount">AMOUNT</label>
                <input type="number" name="amount" id="amount" placeholder="0.00">
            </div>
        </div>

        <div class="page-end">
            <p class="flex gap-6 bold wallet-balance">
                Total Bal.<span><%= balance %></span>
            </p>
            <div class="ctas">
                <button class="cta share">share</button></a>
                <button class="cta submit">Continue</button>
            </div>
        </div>
    </main>
    </section>
    
    <script src="js/dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let walletBalance = 0;
        const balanceElement = document.querySelector('.wallet-balance > span')
        walletBalance = Number(balanceElement.textContent)
        balanceElement.textContent = `N${walletBalance}`

        const networkSelect = document.querySelector('select.network')
        const phoneNumberInput = document.querySelector('input#phoneNumber')
        const amountInput = document.querySelector('input#amount')
        const submitButton = document.querySelector('button.submit')

        const resetInputs = () => {
            networkSelect.value = ""
            phoneNumberInput.value = ""
            amountInput.value = ""
        }

        const validatedData = () => {
            const [service_id, service_type] = networkSelect.value.split(" ")
            const amount = Number(amountInput.value)
            const phoneNumber = phoneNumberInput.value.replaceAll(" ", "")
            if (!service_id || !service_type) {
                alert('pls select network')
                return false
            }
            if (!phoneNumber) {
                alert('pls enter phone number')
                return false
            }
            if (!amount) {
                alert('pls enter amount')
                return false
            }
            if (amount <= 0 || amount % 100 !== 0) {
                alert('amount must be greater than 0 and must be multiple of 100. e.g 100, 200,...')
                return false
            }
            if (walletBalance < amount) {
                alert('not enough balance in your wallet')
                return false
            }
            return {
                service_id, service_type,
                amount, phoneNumber
            }
        }

        const recharge = () => {
            if (!validatedData()) {
                return
            }
            const {
                service_id, service_type,
                amount, phoneNumber
            } = validatedData()
            submitButton.textContent = 'Please wait...'
            axios.post('/api/v1/airtime/recharge', {
                service_id,
                service_type,
                amount,
                phoneNumber
            })
            .then(response => {
                submitButton.textContent = 'Continue'
                const { data } = response
                walletBalance = data.balance || walletBalance - amount
                balanceElement.textContent = `N${walletBalance}`
                resetInputs()
                alert('Your transaction is being processed')
            })
            .catch(error => {
                if (error.response) {
                    const { status, data } = error.response
                    if (status === 401 || status === 403) {
                        window.location.href = '/airtime'
                    }
                    const message = data.message || 'unable to complete transaction'
                    alert(message)
                    submitButton.textContent ='Continue'
                }
                else {
                    alert('pls check your network and try again')
                }
                resetInputs()
            })
        }

        submitButton.addEventListener('click', () => {
            recharge()
        })
    </script>
</body>
</html>